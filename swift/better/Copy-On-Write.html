<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>COW(Copy-On-Write) | OldBirds</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <script data-ad-client="ca-pub-4465026491979447" async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="Swift 有值类型和引用类型，而值类型在被赋值或被传递给函数时是会被拷贝的。在写代码时，这些值类型每次赋值传递都是会重新在内存里拷贝一份吗？">
    <meta name="image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e65062e105f4a34a63025d1a1355baa~tplv-k3u1fbpfcp-watermark.image">
    <meta name="twitter:title" content="COW(Copy-On-Write)">
    <meta name="twitter:description" content="Swift 有值类型和引用类型，而值类型在被赋值或被传递给函数时是会被拷贝的。在写代码时，这些值类型每次赋值传递都是会重新在内存里拷贝一份吗？">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e65062e105f4a34a63025d1a1355baa~tplv-k3u1fbpfcp-watermark.image">
    <meta property="og:type" content="article">
    <meta property="og:title" content="COW(Copy-On-Write)">
    <meta property="og:description" content="Swift 有值类型和引用类型，而值类型在被赋值或被传递给函数时是会被拷贝的。在写代码时，这些值类型每次赋值传递都是会重新在内存里拷贝一份吗？">
    <meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e65062e105f4a34a63025d1a1355baa~tplv-k3u1fbpfcp-watermark.image">
    <meta property="article:published_time" content="2021-12-05T00:00:00.000Z">
    <meta property="article:tag" content="swift">
    <meta itemprop="name" content="COW(Copy-On-Write)">
    <meta itemprop="description" content="Swift 有值类型和引用类型，而值类型在被赋值或被传递给函数时是会被拷贝的。在写代码时，这些值类型每次赋值传递都是会重新在内存里拷贝一份吗？">
    <meta itemprop="image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e65062e105f4a34a63025d1a1355baa~tplv-k3u1fbpfcp-watermark.image">
    <meta name="google-site-verification" content="6EogPdlAJYusvUHenXWXCGX-oVrqdeBnY-WsURHuKAA">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="oldbirds,oldbird,公众号,swift,swiftui,flutter,vapor,ios,figma,数据结构,算法,书单,vuepresss,git,yaml,设计模式,编程">
    
    <link rel="preload" href="/assets/css/0.styles.69e419d6.css" as="style"><link rel="preload" href="/assets/js/app.0aa16e2b.js" as="script"><link rel="preload" href="/assets/js/3.799edd4c.js" as="script"><link rel="preload" href="/assets/js/1.aa25a933.js" as="script"><link rel="preload" href="/assets/js/107.66d7abc7.js" as="script"><link rel="preload" href="/assets/js/8.700d872d.js" as="script"><link rel="prefetch" href="/assets/js/10.bc471f7a.js"><link rel="prefetch" href="/assets/js/100.6560b627.js"><link rel="prefetch" href="/assets/js/101.c970a2fb.js"><link rel="prefetch" href="/assets/js/102.90b2d499.js"><link rel="prefetch" href="/assets/js/103.ee2d1305.js"><link rel="prefetch" href="/assets/js/104.042b167f.js"><link rel="prefetch" href="/assets/js/105.86984b6a.js"><link rel="prefetch" href="/assets/js/106.2ded46b6.js"><link rel="prefetch" href="/assets/js/108.2a25ebe3.js"><link rel="prefetch" href="/assets/js/109.2edf2ab9.js"><link rel="prefetch" href="/assets/js/11.42f64f30.js"><link rel="prefetch" href="/assets/js/110.41ae5aa1.js"><link rel="prefetch" href="/assets/js/111.8b2af7d5.js"><link rel="prefetch" href="/assets/js/112.013e3102.js"><link rel="prefetch" href="/assets/js/113.7cc13fdb.js"><link rel="prefetch" href="/assets/js/114.6224e82f.js"><link rel="prefetch" href="/assets/js/115.9f218a07.js"><link rel="prefetch" href="/assets/js/116.f55d8909.js"><link rel="prefetch" href="/assets/js/117.a48336c0.js"><link rel="prefetch" href="/assets/js/118.1a15c090.js"><link rel="prefetch" href="/assets/js/119.8379f3a4.js"><link rel="prefetch" href="/assets/js/12.8d9c5293.js"><link rel="prefetch" href="/assets/js/120.7b33b0b8.js"><link rel="prefetch" href="/assets/js/121.eef383cd.js"><link rel="prefetch" href="/assets/js/122.310addbb.js"><link rel="prefetch" href="/assets/js/123.e9d05ecc.js"><link rel="prefetch" href="/assets/js/124.9b3dea0e.js"><link rel="prefetch" href="/assets/js/125.a6ec4b6f.js"><link rel="prefetch" href="/assets/js/126.05666764.js"><link rel="prefetch" href="/assets/js/127.ff583c8a.js"><link rel="prefetch" href="/assets/js/128.33a70bfc.js"><link rel="prefetch" href="/assets/js/129.b4976bc3.js"><link rel="prefetch" href="/assets/js/13.d6981eb5.js"><link rel="prefetch" href="/assets/js/130.e085174e.js"><link rel="prefetch" href="/assets/js/131.b46da1b6.js"><link rel="prefetch" href="/assets/js/132.1cd5cd4d.js"><link rel="prefetch" href="/assets/js/133.80b66590.js"><link rel="prefetch" href="/assets/js/134.16ba2b64.js"><link rel="prefetch" href="/assets/js/135.edb10a6f.js"><link rel="prefetch" href="/assets/js/136.9f282d8d.js"><link rel="prefetch" href="/assets/js/137.d1afe419.js"><link rel="prefetch" href="/assets/js/138.ca772163.js"><link rel="prefetch" href="/assets/js/139.2b9149dd.js"><link rel="prefetch" href="/assets/js/14.7a946a8c.js"><link rel="prefetch" href="/assets/js/140.2e628bab.js"><link rel="prefetch" href="/assets/js/141.b137c79f.js"><link rel="prefetch" href="/assets/js/142.6c548d24.js"><link rel="prefetch" href="/assets/js/143.512af4bf.js"><link rel="prefetch" href="/assets/js/144.91f1d214.js"><link rel="prefetch" href="/assets/js/145.a902d886.js"><link rel="prefetch" href="/assets/js/146.d57194d3.js"><link rel="prefetch" href="/assets/js/147.91df0d6a.js"><link rel="prefetch" href="/assets/js/148.99c0bf80.js"><link rel="prefetch" href="/assets/js/149.a8b7c49f.js"><link rel="prefetch" href="/assets/js/15.df02acc9.js"><link rel="prefetch" href="/assets/js/150.1660c2e9.js"><link rel="prefetch" href="/assets/js/151.6e477d14.js"><link rel="prefetch" href="/assets/js/152.18853804.js"><link rel="prefetch" href="/assets/js/153.f0b4c92b.js"><link rel="prefetch" href="/assets/js/154.2bd4c8b1.js"><link rel="prefetch" href="/assets/js/155.e3acdf20.js"><link rel="prefetch" href="/assets/js/156.8d44c1bf.js"><link rel="prefetch" href="/assets/js/157.cab168dd.js"><link rel="prefetch" href="/assets/js/158.bf287653.js"><link rel="prefetch" href="/assets/js/159.bc17569d.js"><link rel="prefetch" href="/assets/js/16.564d894b.js"><link rel="prefetch" href="/assets/js/160.50ed4dce.js"><link rel="prefetch" href="/assets/js/161.cb72c02a.js"><link rel="prefetch" href="/assets/js/162.b20fc9d8.js"><link rel="prefetch" href="/assets/js/163.45975365.js"><link rel="prefetch" href="/assets/js/164.4d5991b5.js"><link rel="prefetch" href="/assets/js/165.043c81cc.js"><link rel="prefetch" href="/assets/js/166.6b09f1cf.js"><link rel="prefetch" href="/assets/js/167.3c583d14.js"><link rel="prefetch" href="/assets/js/168.f555f7e9.js"><link rel="prefetch" href="/assets/js/169.179090a7.js"><link rel="prefetch" href="/assets/js/17.adbf4e27.js"><link rel="prefetch" href="/assets/js/170.aea2b166.js"><link rel="prefetch" href="/assets/js/171.a98d2987.js"><link rel="prefetch" href="/assets/js/172.25bafd90.js"><link rel="prefetch" href="/assets/js/173.d9cfc168.js"><link rel="prefetch" href="/assets/js/174.e1d041fb.js"><link rel="prefetch" href="/assets/js/175.041b4428.js"><link rel="prefetch" href="/assets/js/176.2b8d35c9.js"><link rel="prefetch" href="/assets/js/177.b5adff80.js"><link rel="prefetch" href="/assets/js/178.daff3aa3.js"><link rel="prefetch" href="/assets/js/179.fee83223.js"><link rel="prefetch" href="/assets/js/18.e4503b0a.js"><link rel="prefetch" href="/assets/js/180.5d8f36cc.js"><link rel="prefetch" href="/assets/js/181.59953d22.js"><link rel="prefetch" href="/assets/js/182.35a6b4c3.js"><link rel="prefetch" href="/assets/js/183.17c4ae73.js"><link rel="prefetch" href="/assets/js/184.5ccda8c0.js"><link rel="prefetch" href="/assets/js/185.6238cf00.js"><link rel="prefetch" href="/assets/js/186.127e4b7e.js"><link rel="prefetch" href="/assets/js/187.b456c5c3.js"><link rel="prefetch" href="/assets/js/188.74edaac0.js"><link rel="prefetch" href="/assets/js/189.76db22a2.js"><link rel="prefetch" href="/assets/js/19.3d2241bd.js"><link rel="prefetch" href="/assets/js/190.9437abbd.js"><link rel="prefetch" href="/assets/js/191.9e47314e.js"><link rel="prefetch" href="/assets/js/192.a13ea326.js"><link rel="prefetch" href="/assets/js/193.e9a448ca.js"><link rel="prefetch" href="/assets/js/194.111f3a9a.js"><link rel="prefetch" href="/assets/js/195.5a715e14.js"><link rel="prefetch" href="/assets/js/196.2204065b.js"><link rel="prefetch" href="/assets/js/197.c777d77f.js"><link rel="prefetch" href="/assets/js/198.96aa6cd4.js"><link rel="prefetch" href="/assets/js/199.3064943b.js"><link rel="prefetch" href="/assets/js/20.61aa10a1.js"><link rel="prefetch" href="/assets/js/200.e7966a51.js"><link rel="prefetch" href="/assets/js/201.98a59997.js"><link rel="prefetch" href="/assets/js/202.a52b2498.js"><link rel="prefetch" href="/assets/js/203.ca179f54.js"><link rel="prefetch" href="/assets/js/204.023bae73.js"><link rel="prefetch" href="/assets/js/205.5b45146a.js"><link rel="prefetch" href="/assets/js/206.7d342f6d.js"><link rel="prefetch" href="/assets/js/207.2e01fbab.js"><link rel="prefetch" href="/assets/js/208.7c74aa81.js"><link rel="prefetch" href="/assets/js/209.f26bba12.js"><link rel="prefetch" href="/assets/js/21.10b4569d.js"><link rel="prefetch" href="/assets/js/210.0c127d83.js"><link rel="prefetch" href="/assets/js/211.8b1181ec.js"><link rel="prefetch" href="/assets/js/212.0202d677.js"><link rel="prefetch" href="/assets/js/213.defd8c17.js"><link rel="prefetch" href="/assets/js/214.85a79cd0.js"><link rel="prefetch" href="/assets/js/215.7ef524b3.js"><link rel="prefetch" href="/assets/js/216.51cfe185.js"><link rel="prefetch" href="/assets/js/217.8ce35237.js"><link rel="prefetch" href="/assets/js/218.e1424083.js"><link rel="prefetch" href="/assets/js/219.0f2ec8ff.js"><link rel="prefetch" href="/assets/js/22.20fbd596.js"><link rel="prefetch" href="/assets/js/220.99959e27.js"><link rel="prefetch" href="/assets/js/221.427810a3.js"><link rel="prefetch" href="/assets/js/222.c801eaf8.js"><link rel="prefetch" href="/assets/js/223.2d7cb602.js"><link rel="prefetch" href="/assets/js/224.1a946310.js"><link rel="prefetch" href="/assets/js/23.9f5c3a3d.js"><link rel="prefetch" href="/assets/js/24.f4ff0702.js"><link rel="prefetch" href="/assets/js/25.ef9e6863.js"><link rel="prefetch" href="/assets/js/26.4129a7fc.js"><link rel="prefetch" href="/assets/js/27.11ae4590.js"><link rel="prefetch" href="/assets/js/28.9f159f91.js"><link rel="prefetch" href="/assets/js/29.4f8fc819.js"><link rel="prefetch" href="/assets/js/30.43abe8a4.js"><link rel="prefetch" href="/assets/js/31.228a1769.js"><link rel="prefetch" href="/assets/js/32.165b6d7a.js"><link rel="prefetch" href="/assets/js/33.21573b42.js"><link rel="prefetch" href="/assets/js/34.b2e76c72.js"><link rel="prefetch" href="/assets/js/35.88962c32.js"><link rel="prefetch" href="/assets/js/36.b795d8c0.js"><link rel="prefetch" href="/assets/js/37.356ed9f4.js"><link rel="prefetch" href="/assets/js/38.2a4dd5f5.js"><link rel="prefetch" href="/assets/js/39.f781bb97.js"><link rel="prefetch" href="/assets/js/4.d8a1ff43.js"><link rel="prefetch" href="/assets/js/40.4c76b795.js"><link rel="prefetch" href="/assets/js/41.198933b5.js"><link rel="prefetch" href="/assets/js/42.8d322209.js"><link rel="prefetch" href="/assets/js/43.30f504e8.js"><link rel="prefetch" href="/assets/js/44.b28e6add.js"><link rel="prefetch" href="/assets/js/45.ca6ccb32.js"><link rel="prefetch" href="/assets/js/46.7d8cae06.js"><link rel="prefetch" href="/assets/js/47.e02f0a81.js"><link rel="prefetch" href="/assets/js/48.a956ea1d.js"><link rel="prefetch" href="/assets/js/49.55583a14.js"><link rel="prefetch" href="/assets/js/5.2d5717cc.js"><link rel="prefetch" href="/assets/js/50.421e9ac2.js"><link rel="prefetch" href="/assets/js/51.5f4fc92b.js"><link rel="prefetch" href="/assets/js/52.8daaa0fc.js"><link rel="prefetch" href="/assets/js/53.b1a72dfd.js"><link rel="prefetch" href="/assets/js/54.e60de045.js"><link rel="prefetch" href="/assets/js/55.8aef5ef4.js"><link rel="prefetch" href="/assets/js/56.83002e20.js"><link rel="prefetch" href="/assets/js/57.49899604.js"><link rel="prefetch" href="/assets/js/58.d3306965.js"><link rel="prefetch" href="/assets/js/59.2ef891ca.js"><link rel="prefetch" href="/assets/js/6.81af9301.js"><link rel="prefetch" href="/assets/js/60.6514d71e.js"><link rel="prefetch" href="/assets/js/61.4e6499d7.js"><link rel="prefetch" href="/assets/js/62.241ed18e.js"><link rel="prefetch" href="/assets/js/63.e0c7dfe0.js"><link rel="prefetch" href="/assets/js/64.a46be040.js"><link rel="prefetch" href="/assets/js/65.bef781c6.js"><link rel="prefetch" href="/assets/js/66.fdfe29c2.js"><link rel="prefetch" href="/assets/js/67.4713ffc8.js"><link rel="prefetch" href="/assets/js/68.f8ca7d2d.js"><link rel="prefetch" href="/assets/js/69.164acd8b.js"><link rel="prefetch" href="/assets/js/7.8702dca7.js"><link rel="prefetch" href="/assets/js/70.9fd465e0.js"><link rel="prefetch" href="/assets/js/71.0b318b3c.js"><link rel="prefetch" href="/assets/js/72.59be8861.js"><link rel="prefetch" href="/assets/js/73.47d7c490.js"><link rel="prefetch" href="/assets/js/74.78538f2f.js"><link rel="prefetch" href="/assets/js/75.cc8eaa99.js"><link rel="prefetch" href="/assets/js/76.6f2fb2fd.js"><link rel="prefetch" href="/assets/js/77.e6a5cf48.js"><link rel="prefetch" href="/assets/js/78.06abf235.js"><link rel="prefetch" href="/assets/js/79.a1b85b34.js"><link rel="prefetch" href="/assets/js/80.60c49e1b.js"><link rel="prefetch" href="/assets/js/81.0fa527bb.js"><link rel="prefetch" href="/assets/js/82.3878d3a3.js"><link rel="prefetch" href="/assets/js/83.1ab125f5.js"><link rel="prefetch" href="/assets/js/84.ece69aa7.js"><link rel="prefetch" href="/assets/js/85.3496a36e.js"><link rel="prefetch" href="/assets/js/86.6b6987d5.js"><link rel="prefetch" href="/assets/js/87.dc24de52.js"><link rel="prefetch" href="/assets/js/88.5a8e1361.js"><link rel="prefetch" href="/assets/js/89.046e357a.js"><link rel="prefetch" href="/assets/js/9.146dde97.js"><link rel="prefetch" href="/assets/js/90.2837a7d4.js"><link rel="prefetch" href="/assets/js/91.15806e36.js"><link rel="prefetch" href="/assets/js/92.04b9c26a.js"><link rel="prefetch" href="/assets/js/93.28912d0f.js"><link rel="prefetch" href="/assets/js/94.c2738daa.js"><link rel="prefetch" href="/assets/js/95.c37b2174.js"><link rel="prefetch" href="/assets/js/96.5bcfb84e.js"><link rel="prefetch" href="/assets/js/97.4de6a155.js"><link rel="prefetch" href="/assets/js/98.c329d5dc.js"><link rel="prefetch" href="/assets/js/99.90294734.js">
    <link rel="stylesheet" href="/assets/css/0.styles.69e419d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>OldBirds</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>过来人的笔记，带你最佳实践，@OldBirds公众号</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>oldbirds</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="OldBirds" class="logo"> <span class="site-name">OldBirds</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Swift
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/swift/better/" class="nav-link router-link-active"><i class="undefined"></i>
  写更好的Swift代码系列
</a></li><li class="dropdown-item"><!----> <a href="/swift/swiftui/" class="nav-link"><i class="undefined"></i>
  SwiftUI
</a></li><li class="dropdown-item"><!----> <a href="/swift/vapor/" class="nav-link"><i class="undefined"></i>
  Vapor
</a></li><li class="dropdown-item"><!----> <a href="/swift/ios/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/swift/tips/" class="nav-link"><i class="undefined"></i>
  Tips
</a></li><li class="dropdown-item"><!----> <a href="/swift/fp/" class="nav-link"><i class="undefined"></i>
  函数式编程
</a></li></ul></div></div><div class="nav-item"><a href="/python/" class="nav-link"><i class="undefined"></i>
  Python
</a></div><div class="nav-item"><a href="/haskell/" class="nav-link"><i class="undefined"></i>
  Haskell
</a></div><div class="nav-item"><a href="/flutter/" class="nav-link"><i class="undefined"></i>
  Flutter
</a></div><div class="nav-item"><a href="/ai/" class="nav-link"><i class="undefined"></i>
  AI
</a></div><div class="nav-item"><a href="/figma/" class="nav-link"><i class="undefined"></i>
  Figma
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basis/index/" class="nav-link"><i class="undefined"></i>
  概要
</a></li><li class="dropdown-item"><!----> <a href="/basis/algorithms/" class="nav-link"><i class="undefined"></i>
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/basis/os/" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/basis/design-patterns/" class="nav-link"><i class="undefined"></i>
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/basis/cmake/" class="nav-link"><i class="undefined"></i>
  CMake
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vuepress/" class="nav-link"><i class="undefined"></i>
  VuePress
</a></li><li class="dropdown-item"><!----> <a href="/tools/git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/tools/yaml/" class="nav-link"><i class="undefined"></i>
  YAML
</a></li><li class="dropdown-item"><!----> <a href="/tools/html/" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/tools/plantuml/" class="nav-link"><i class="undefined"></i>
  PlantUML
</a></li></ul></div></div><div class="nav-item"><a href="https://oldbird.run/books/#/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  书单
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/index/" class="nav-link"><i class="undefined"></i>
  关于我们
</a></li><li class="dropdown-item"><!----> <a href="/about/app/" class="nav-link"><i class="undefined"></i>
  APP
</a></li></ul></div></div> <a href="https://github.com/swiftdo/swiftdo.github.io" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/logo.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    oldbirds
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>199</h3> <h6 data-v-828910c6>Articles</h6></div> <div data-v-828910c6><h3 data-v-828910c6>24</h3> <h6 data-v-828910c6>Tags</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Swift
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/swift/better/" class="nav-link router-link-active"><i class="undefined"></i>
  写更好的Swift代码系列
</a></li><li class="dropdown-item"><!----> <a href="/swift/swiftui/" class="nav-link"><i class="undefined"></i>
  SwiftUI
</a></li><li class="dropdown-item"><!----> <a href="/swift/vapor/" class="nav-link"><i class="undefined"></i>
  Vapor
</a></li><li class="dropdown-item"><!----> <a href="/swift/ios/" class="nav-link"><i class="undefined"></i>
  iOS
</a></li><li class="dropdown-item"><!----> <a href="/swift/tips/" class="nav-link"><i class="undefined"></i>
  Tips
</a></li><li class="dropdown-item"><!----> <a href="/swift/fp/" class="nav-link"><i class="undefined"></i>
  函数式编程
</a></li></ul></div></div><div class="nav-item"><a href="/python/" class="nav-link"><i class="undefined"></i>
  Python
</a></div><div class="nav-item"><a href="/haskell/" class="nav-link"><i class="undefined"></i>
  Haskell
</a></div><div class="nav-item"><a href="/flutter/" class="nav-link"><i class="undefined"></i>
  Flutter
</a></div><div class="nav-item"><a href="/ai/" class="nav-link"><i class="undefined"></i>
  AI
</a></div><div class="nav-item"><a href="/figma/" class="nav-link"><i class="undefined"></i>
  Figma
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      基础
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basis/index/" class="nav-link"><i class="undefined"></i>
  概要
</a></li><li class="dropdown-item"><!----> <a href="/basis/algorithms/" class="nav-link"><i class="undefined"></i>
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/basis/os/" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/basis/design-patterns/" class="nav-link"><i class="undefined"></i>
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/basis/cmake/" class="nav-link"><i class="undefined"></i>
  CMake
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vuepress/" class="nav-link"><i class="undefined"></i>
  VuePress
</a></li><li class="dropdown-item"><!----> <a href="/tools/git/" class="nav-link"><i class="undefined"></i>
  Git
</a></li><li class="dropdown-item"><!----> <a href="/tools/yaml/" class="nav-link"><i class="undefined"></i>
  YAML
</a></li><li class="dropdown-item"><!----> <a href="/tools/html/" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/tools/plantuml/" class="nav-link"><i class="undefined"></i>
  PlantUML
</a></li></ul></div></div><div class="nav-item"><a href="https://oldbird.run/books/#/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  书单
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/about/index/" class="nav-link"><i class="undefined"></i>
  关于我们
</a></li><li class="dropdown-item"><!----> <a href="/about/app/" class="nav-link"><i class="undefined"></i>
  APP
</a></li></ul></div></div> <a href="https://github.com/swiftdo/swiftdo.github.io" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>写更好的Swift代码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/swift/better/autoclosure.html" class="sidebar-link">@autoclosure</a></li><li><a href="/swift/better/protocol.html" class="sidebar-link">关联协议与类型擦除</a></li><li><a href="/swift/better/chain.html" class="sidebar-link">链式调用与@dynamicMemberLookup</a></li><li><a href="/swift/better/Copy-On-Write.html" aria-current="page" class="active sidebar-link">COW(Copy-On-Write)</a></li><li><a href="/swift/better/copy-in-copy-out.html" class="sidebar-link">inout(copy-in-copy-out)</a></li><li><a href="/swift/better/di.html" class="sidebar-link">DI(依赖注入)</a></li><li><a href="/swift/better/lazy.html" class="sidebar-link">性能优化利器 Lazy</a></li><li><a href="/swift/better/available.html" class="sidebar-link">@available 与调用方进行沟通</a></li><li><a href="/swift/better/last.html" class="sidebar-link">技巧拾遗</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc></h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>oldbirds</span>
            
          <span data-v-4e82dffc>2020 - </span>
          2021
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">COW(Copy-On-Write)</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>oldbirds</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>12/5/2021</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>swift</span><span class="tag-item" data-v-1ff7123e>ios</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="cow-copy-on-write"><a href="#cow-copy-on-write" class="header-anchor">#</a> COW(Copy-On-Write)</h1> <p>Swift 有值类型和引用类型，而值类型在被赋值或被传递给函数时是会被拷贝的。在写代码时，这些值类型每次赋值传递都是会重新在内存里拷贝一份吗？</p> <p>答案是否定的。如有个包含上千个元素的数组，然后你把它 copy 一份给另一个变量，那么 Swift 就要拷贝所有的元素，即使这两个变量的数组内容完全一样，这对它性能来说是多么糟糕。</p> <p>在 <a href="https://docs.swift.org/swift-book/LanguageGuide/ClassesAndStructures.html#//apple_ref/doc/uid/TP40014097-CH13-ID82" target="_blank" rel="nofollow noopener noreferrer">Structures and Enumerations Are Value Types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 明确的提到了对其实现做了优化，可避免不必要的复制：</p> <blockquote><p>Collections defined by the standard library like arrays, dictionaries, and strings use an optimization to reduce the performance cost of copying. Instead of making a copy immediately, these collections share the memory where the elements are stored between the original instance and any copies. If one of the copies of the collection is modified, the elements are copied just before the modification. The behavior you see in your code is always as if a copy took place immediately.</p></blockquote> <p>使用了 COW, 当将两个变量指向同一数组时，他们指向相同的底层数据。当修改第二个变量的时候，Swift 才会去复制一个副本，第一个不会改变。</p> <ul><li>通过延迟复制操作，直到实际使用到的时候才去复制，以此确保没有浪费的工作。</li> <li>使得值类型可以被多次复制而无需耗费多余的内存，只有在变化的时候才会增加开销。因此内存的使用更加高效。</li></ul> <p>下面我们一起来验证下上面所说：</p> <h2 id="基本类型-int、string-等"><a href="#基本类型-int、string-等" class="header-anchor">#</a> 基本类型(Int、String 等):</h2> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token class-name">Foundation</span>

<span class="token keyword">var</span> num1 <span class="token operator">=</span> <span class="token number">101</span>
<span class="token keyword">var</span> num2 <span class="token operator">=</span> num1
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>num1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x108074090</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>num2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x108074098</span>

<span class="token keyword">var</span> str1 <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;oldbirds&quot;</span></span>
<span class="token keyword">var</span> str2 <span class="token operator">=</span> str1
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x1080740a0</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x1080740b0</span>

<span class="token comment">//打印内存地址</span>
<span class="token keyword">func</span> <span class="token function-definition function">address</span><span class="token punctuation">(</span>of object<span class="token punctuation">:</span> <span class="token class-name">UnsafeRawPointer</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> addr <span class="token operator">=</span> <span class="token class-name">Int</span><span class="token punctuation">(</span>bitPattern<span class="token punctuation">:</span> object<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token class-name">NSString</span><span class="token punctuation">(</span>format<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;%p&quot;</span></span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">String</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="集合类型"><a href="#集合类型" class="header-anchor">#</a> 集合类型</h2> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">var</span> arr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> arr2 <span class="token operator">=</span> arr1
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>arr1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x600000e55510</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>arr2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x600000e55510</span>

arr2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>arr1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x600000e55510</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>arr2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//0x600000e55dd0</span>
</code></pre></div><h2 id="自定义类型"><a href="#自定义类型" class="header-anchor">#</a> 自定义类型</h2> <p>COW 是特别添加到 Swift 数组和字典的功能，自定义的数据类型不会自动实现。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">struct</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;&quot;</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;oldbirds&quot;</span></span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>p1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0x101ab32d0</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> p1
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0x101ab32e0</span>
p2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;like&quot;</span></span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span>p2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0x101ab32e0</span>
</code></pre></div><p>上述代码可以看出，虽然将 p1 赋值给了 p2，但它俩的内存地址依然是不同的。由此可见自定义的结构体并不能支持 Copy-on-Write。</p> <h2 id="copy-on-write-如何实现的"><a href="#copy-on-write-如何实现的" class="header-anchor">#</a> Copy-on-Write 如何实现的</h2> <p>你可以在 <a href="https://github.com/apple/swift/blob/main/docs/OptimizationTips.rst#id29" target="_blank" rel="nofollow noopener noreferrer">OptimizationTips.rst<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 里发现如下代码:</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> val <span class="token punctuation">:</span> <span class="token class-name">T</span>
  <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> v <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>val <span class="token operator">=</span> v<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ref <span class="token punctuation">:</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> x <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ref <span class="token operator">=</span> <span class="token class-name">Ref</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token keyword">var</span> value<span class="token punctuation">:</span> <span class="token class-name">T</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> ref<span class="token punctuation">.</span>val <span class="token punctuation">}</span>
        <span class="token keyword">set</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isKnownUniquelyReferenced</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ref<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ref <span class="token operator">=</span> <span class="token class-name">Ref</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          ref<span class="token punctuation">.</span>val <span class="token operator">=</span> newValue
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>isKnownUniquelyReferenced</code>用来检查某个实例是不是唯一的引用。</p> <p>该例子显示了如何用一个引用类型去实现一个拥有 Copy-on-Write 特性的泛型值类型 T。当你调用 set 的时候判断是否有多个 reference，如果是多个 reference 则进行拷贝，反之则不会。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">struct</span> <span class="token class-name">Persion</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;oldbirds&quot;</span></span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> oldbirds <span class="token operator">=</span> <span class="token class-name">Persion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> box <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>oldbirds<span class="token punctuation">)</span>
<span class="token keyword">var</span> box2 <span class="token operator">=</span> box <span class="token comment">// box2 与 box 共享 box.ref</span>
<span class="token function">print</span><span class="token punctuation">(</span>box<span class="token punctuation">.</span>value<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// oldbirds</span>
<span class="token function">print</span><span class="token punctuation">(</span>box2<span class="token punctuation">.</span>value<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// oldbirds</span>

box2<span class="token punctuation">.</span>value<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;like&quot;</span></span> <span class="token comment">// box2 会创建新的 ref</span>
<span class="token function">print</span><span class="token punctuation">(</span>box<span class="token punctuation">.</span>value<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// oldbirds</span>
<span class="token function">print</span><span class="token punctuation">(</span>box2<span class="token punctuation">.</span>value<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// like</span>
</code></pre></div><p>Swift 标准库中大量使用了这种技术。</p> <p>有了上面的技术理论，我们一起来运用 COW 技术：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token class-name">UIKit</span>
<span class="token keyword">import</span> <span class="token class-name">PlaygroundSupport</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> value<span class="token punctuation">:</span> <span class="token class-name">A</span>
  <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> value<span class="token punctuation">:</span> <span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 高斯模糊</span>
<span class="token keyword">struct</span> <span class="token class-name">GaussianBlur</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> boxedFilter<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">CIFilter</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> filter <span class="token operator">=</span> <span class="token class-name">CIFilter</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;CIGaussianBlur&quot;</span></span><span class="token punctuation">,</span> parameters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">!</span>
        filter<span class="token punctuation">.</span><span class="token function">setDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> filter<span class="token punctuation">:</span> <span class="token class-name">CIFilter</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">{</span> boxedFilter<span class="token punctuation">.</span>value <span class="token punctuation">}</span>
        <span class="token keyword">set</span> <span class="token punctuation">{</span> boxedFilter <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> filterForWriting<span class="token punctuation">:</span> <span class="token class-name">CIFilter</span> <span class="token punctuation">{</span>
        <span class="token keyword">mutating</span> <span class="token keyword">get</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isKnownUniquelyReferenced</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>boxedFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            filter <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">!</span> <span class="token class-name">CIFilter</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;😄拷贝filter，</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;共享filter, </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token function">address</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> filter
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> inputImage<span class="token punctuation">:</span> <span class="token class-name">CIImage</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> filter<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token constant">kCIInputImageKey</span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">!</span> <span class="token class-name">CIImage</span> <span class="token punctuation">}</span>
        <span class="token keyword">set</span> <span class="token punctuation">{</span> filterForWriting<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token constant">kCIInputImageKey</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> radius<span class="token punctuation">:</span> <span class="token class-name">Double</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> filter<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>forKey<span class="token punctuation">:</span> <span class="token constant">kCIInputRadiusKey</span><span class="token punctuation">)</span> <span class="token keyword">as</span><span class="token operator">!</span> <span class="token class-name">Double</span> <span class="token punctuation">}</span>
        <span class="token keyword">set</span> <span class="token punctuation">{</span> filterForWriting<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> forKey<span class="token punctuation">:</span> <span class="token constant">kCIInputRadiusKey</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> outputImage<span class="token punctuation">:</span> <span class="token class-name">CIImage</span><span class="token operator">?</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> filter<span class="token punctuation">.</span>outputImage
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token class-name">UIView</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> <span class="token class-name">CGRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">320</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">660</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> imgUrl <span class="token operator">=</span> <span class="token class-name">Bundle</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>forResource<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;6924717&quot;</span></span><span class="token punctuation">,</span> withExtension<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;jpeg&quot;</span></span><span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token keyword">let</span> beginImage <span class="token operator">=</span> <span class="token class-name">CIImage</span><span class="token punctuation">(</span>contentsOf<span class="token punctuation">:</span> imgUrl<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token keyword">var</span> gaussianBlur <span class="token operator">=</span> <span class="token class-name">GaussianBlur</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
gaussianBlur<span class="token punctuation">.</span>radius <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">// 共享</span>
gaussianBlur<span class="token punctuation">.</span>inputImage <span class="token operator">=</span> beginImage <span class="token comment">// 共享</span>
<span class="token keyword">let</span> filterImg <span class="token operator">=</span> <span class="token class-name">UIImageView</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> <span class="token class-name">CGRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
filterImg<span class="token punctuation">.</span>image <span class="token operator">=</span> <span class="token class-name">UIImage</span><span class="token punctuation">(</span>ciImage<span class="token punctuation">:</span> gaussianBlur<span class="token punctuation">.</span>outputImage<span class="token operator">!</span><span class="token punctuation">)</span>
view<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>filterImg<span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;\n&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">var</span> gaussianBlur2 <span class="token operator">=</span> gaussianBlur
gaussianBlur2<span class="token punctuation">.</span>radius <span class="token operator">=</span> <span class="token number">10</span>
gaussianBlur2<span class="token punctuation">.</span>inputImage <span class="token operator">=</span> beginImage
<span class="token keyword">let</span> filterImg2 <span class="token operator">=</span> <span class="token class-name">UIImageView</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> <span class="token class-name">CGRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">220</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
filterImg2<span class="token punctuation">.</span>image <span class="token operator">=</span> <span class="token class-name">UIImage</span><span class="token punctuation">(</span>ciImage<span class="token punctuation">:</span> gaussianBlur2<span class="token punctuation">.</span>outputImage<span class="token operator">!</span><span class="token punctuation">)</span>
view<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>filterImg2<span class="token punctuation">)</span>
<span class="token class-name">PlaygroundPage</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>liveView <span class="token operator">=</span> view

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;\n&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">var</span> gaussianBlur3 <span class="token operator">=</span> gaussianBlur
gaussianBlur3<span class="token punctuation">.</span>radius <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">let</span> filterImg3 <span class="token operator">=</span> <span class="token class-name">UIImageView</span><span class="token punctuation">(</span>frame<span class="token punctuation">:</span> <span class="token class-name">CGRect</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">440</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token number">300</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
filterImg3<span class="token punctuation">.</span>image <span class="token operator">=</span> <span class="token class-name">UIImage</span><span class="token punctuation">(</span>ciImage<span class="token punctuation">:</span> gaussianBlur3<span class="token punctuation">.</span>outputImage<span class="token operator">!</span><span class="token punctuation">)</span>
view<span class="token punctuation">.</span><span class="token function">addSubview</span><span class="token punctuation">(</span>filterImg3<span class="token punctuation">)</span>
<span class="token class-name">PlaygroundPage</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>liveView <span class="token operator">=</span> view

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;OK&quot;</span></span><span class="token punctuation">)</span>
</code></pre></div><p>输出结果:</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e65062e105f4a34a63025d1a1355baa~tplv-k3u1fbpfcp-watermark.image" alt="cart" loading="lazy" style="min-width:100px;min-height:100px;background:url(data:image/gif;base64,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) no-repeat center;background-size:30px 30px;"></p> <div class="language-swift extra-class"><pre class="language-swift"><code>共享filter<span class="token punctuation">,</span> <span class="token number">0x107547678</span>
共享filter<span class="token punctuation">,</span> <span class="token number">0x107547678</span>
共享filter<span class="token punctuation">,</span> <span class="token number">0x107547678</span>
共享filter<span class="token punctuation">,</span> <span class="token number">0x107547678</span>

😄拷贝filter，<span class="token number">0x107547688</span>
共享filter<span class="token punctuation">,</span> <span class="token number">0x107547688</span>
共享filter<span class="token punctuation">,</span> <span class="token number">0x107547688</span>
共享filter<span class="token punctuation">,</span> <span class="token number">0x107547688</span>

😄拷贝filter，<span class="token number">0x107547698</span>
共享filter<span class="token punctuation">,</span> <span class="token number">0x107547698</span>
<span class="token constant">OK</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结：</h2> <ul><li>Copy-on-Write 是一种用来优化占用内存大的值类型的拷贝操作的机制。</li> <li>对于 Int，Double，String 等基本类型的值类型，它们在赋值的时候就会发生拷贝。</li> <li>对于 Array、Dictionary、Set 类型，当它们赋值的时候不会发生拷贝，只有在修改的之后才会发生拷贝。</li> <li>对于自定义的数据类型不会自动实现 COW，可按需实现。</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">12/6/2021, 9:22:35 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/swift/better/chain.html" class="prev">
            链式调用与@dynamicMemberLookup
          </a></span> <span class="next"><a href="/swift/better/copy-in-copy-out.html">
            inout(copy-in-copy-out)
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/swift/better/Copy-On-Write.html#基本类型-int、string-等" class="sidebar-link reco-side-基本类型-int、string-等" data-v-70334359>基本类型(Int、String 等):</a></li><li class="level-2" data-v-70334359><a href="/swift/better/Copy-On-Write.html#集合类型" class="sidebar-link reco-side-集合类型" data-v-70334359>集合类型</a></li><li class="level-2" data-v-70334359><a href="/swift/better/Copy-On-Write.html#自定义类型" class="sidebar-link reco-side-自定义类型" data-v-70334359>自定义类型</a></li><li class="level-2" data-v-70334359><a href="/swift/better/Copy-On-Write.html#copy-on-write-如何实现的" class="sidebar-link reco-side-copy-on-write-如何实现的" data-v-70334359>Copy-on-Write 如何实现的</a></li><li class="level-2" data-v-70334359><a href="/swift/better/Copy-On-Write.html#总结" class="sidebar-link reco-side-总结" data-v-70334359>总结：</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><!----><!----><!----><!----></div></div>
    <script src="/assets/js/app.0aa16e2b.js" defer></script><script src="/assets/js/3.799edd4c.js" defer></script><script src="/assets/js/1.aa25a933.js" defer></script><script src="/assets/js/107.66d7abc7.js" defer></script><script src="/assets/js/8.700d872d.js" defer></script>
  </body>
</html>
